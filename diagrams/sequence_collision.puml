@startuml Collision_Detection_Sequence

participant PlayingState
participant GameManager
participant Player
participant Enemy
participant Explosion
participant SoundManager

== Explosion vs Player Collision ==

loop Every Frame (while explosions exist)
    PlayingState -> GameManager: getExplosions()
    activate GameManager
    GameManager --> PlayingState: explosionList
    deactivate GameManager
    
    loop For each Explosion
        PlayingState -> Explosion: update()
        activate Explosion
        Explosion -> Explosion: timer--
        Explosion --> PlayingState
        deactivate Explosion
        
        PlayingState -> GameManager: getPlayer()
        activate GameManager
        GameManager --> PlayingState: player
        deactivate GameManager
        
        PlayingState -> Explosion: getX(), getY()
        activate Explosion
        Explosion --> PlayingState: ex, ey
        deactivate Explosion
        
        PlayingState -> Player: getX(), getY()
        activate Player
        Player --> PlayingState: px, py
        deactivate Player
        
        alt ex == px && ey == py
            PlayingState -> Player: damage()
            activate Player
            
            alt invincibleTimer <= 0
                Player -> Player: hp--
                Player -> Player: invincibleTimer = 120
                Player --> PlayingState: true (damage taken)
                
                note right of Player
                    Player is invincible for
                    120 frames (2 seconds)
                    after taking damage
                end note
            else invincible
                Player --> PlayingState: false (no damage)
            end
            deactivate Player
            
            alt Damage taken
                alt player.hp <= 0
                    PlayingState -> SoundManager: playSFX(SFX_DEATH)
                    activate SoundManager
                    SoundManager --> PlayingState
                    deactivate SoundManager
                    
                    note right of PlayingState
                        Player dies, will trigger
                        Game Over state
                    end note
                else player.hp > 0
                    PlayingState -> SoundManager: playSFX(SFX_DAMAGE)
                    activate SoundManager
                    SoundManager --> PlayingState
                    deactivate SoundManager
                end
            end
        end
        
        alt !explosion.isActive()
            PlayingState -> GameManager: explosions.remove(explosion)
        end
    end
end

== Explosion vs Enemy Collision ==

loop For each Explosion
    PlayingState -> GameManager: getEnemies()
    activate GameManager
    GameManager --> PlayingState: enemyList
    deactivate GameManager
    
    loop For each Enemy
        PlayingState -> Explosion: getX(), getY()
        activate Explosion
        Explosion --> PlayingState: ex, ey
        deactivate Explosion
        
        PlayingState -> Enemy: getX(), getY()
        activate Enemy
        Enemy --> PlayingState: enx, eny
        deactivate Enemy
        
        alt ex == enx && ey == eny
            PlayingState -> GameManager: enemies.remove(enemy)
            activate GameManager
            GameManager --> PlayingState
            deactivate GameManager
            
            note right of PlayingState
                Enemy is instantly killed
                by explosion
            end note
        end
    end
end

== Enemy vs Player Collision ==

loop Every Frame
    PlayingState -> GameManager: getEnemies()
    activate GameManager
    GameManager --> PlayingState: enemyList
    deactivate GameManager
    
    loop For each Enemy
        PlayingState -> Enemy: tryMove(walls, enemies, bombs, player, w, h)
        activate Enemy
        
        Enemy -> Enemy: AI pathfinding\ntowards player
        
        Enemy -> Enemy: Check valid move
        
        alt Valid move
            Enemy -> Enemy: x = newX, y = newY
        end
        
        Enemy --> PlayingState
        deactivate Enemy
        
        PlayingState -> GameManager: getPlayer()
        activate GameManager
        GameManager --> PlayingState: player
        deactivate GameManager
        
        PlayingState -> Enemy: getX(), getY()
        activate Enemy
        Enemy --> PlayingState: ex, ey
        deactivate Enemy
        
        PlayingState -> Player: getX(), getY()
        activate Player
        Player --> PlayingState: px, py
        deactivate Player
        
        alt ex == px && ey == py
            PlayingState -> Player: damage()
            activate Player
            
            alt invincibleTimer <= 0
                Player -> Player: hp--
                Player -> Player: invincibleTimer = 120
                Player --> PlayingState: true (damage taken)
            else invincible
                Player --> PlayingState: false (no damage)
            end
            deactivate Player
            
            alt Damage taken
                alt player.hp <= 0
                    PlayingState -> SoundManager: playSFX(SFX_DEATH)
                    activate SoundManager
                    SoundManager --> PlayingState
                    deactivate SoundManager
                else player.hp > 0
                    PlayingState -> SoundManager: playSFX(SFX_DAMAGE)
                    activate SoundManager
                    SoundManager --> PlayingState
                    deactivate SoundManager
                end
            end
        end
    end
end

== Game State Check ==

PlayingState -> Player: getHp()
activate Player
Player --> PlayingState: hp
deactivate Player

alt hp <= 0
    PlayingState -> GameManager: setState(GAMEOVER_STATE)
    activate GameManager
    GameManager -> GameManager: currentState = GAMEOVER_STATE
    GameManager --> PlayingState
    deactivate GameManager
end

PlayingState -> GameManager: getEnemies().isEmpty()
activate GameManager
GameManager --> PlayingState: true/false
deactivate GameManager

alt All enemies defeated
    PlayingState -> GameManager: calculateScore()
    activate GameManager
    GameManager -> GameManager: lastGameTime = elapsed
    GameManager --> PlayingState
    deactivate GameManager
    
    PlayingState -> GameManager: setState(VICTORY_STATE)
    activate GameManager
    GameManager --> PlayingState
    deactivate GameManager
    
    PlayingState -> SoundManager: playSFX(SFX_WIN)
    activate SoundManager
    SoundManager --> PlayingState
    deactivate SoundManager
end

@enduml

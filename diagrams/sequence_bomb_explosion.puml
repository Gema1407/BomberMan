@startuml Bomb_Placement_and_Explosion_Sequence

actor Player
participant PlayingState
participant GameManager
participant EntityFactory
participant Bomb
participant Explosion
participant SoundManager
participant Enemy
participant Wall

== Bomb Placement ==

Player -> PlayingState: Press SPACE
activate PlayingState

PlayingState -> GameManager: getPlayer()
activate GameManager
GameManager --> PlayingState: player
deactivate GameManager

PlayingState -> GameManager: getBombs()
activate GameManager
GameManager --> PlayingState: bombList
deactivate GameManager

PlayingState -> PlayingState: Check if bomb\nalready at position

PlayingState -> PlayingState: Check bomb count\n< MAX_BOMBS

alt Can place bomb
    PlayingState -> EntityFactory: createBomb(x, y, radius)
    activate EntityFactory
    
    EntityFactory -> Bomb: new Bomb(x, y, radius)
    activate Bomb
    
    Bomb -> Bomb: timer = 120
    Bomb -> Bomb: color = BLACK
    
    Bomb --> EntityFactory: bomb instance
    deactivate Bomb
    
    EntityFactory --> PlayingState: bomb
    deactivate EntityFactory
    
    PlayingState -> GameManager: getBombs().add(bomb)
    activate GameManager
    GameManager --> PlayingState
    deactivate GameManager
    
    PlayingState -> SoundManager: playSFX(SFX_BOMB_PLACE)
    activate SoundManager
    SoundManager -> SoundManager: Find clip
    SoundManager -> SoundManager: setFramePosition(0)
    SoundManager -> SoundManager: clip.start()
    SoundManager --> PlayingState
    deactivate SoundManager
end

PlayingState --> Player
deactivate PlayingState

== Bomb Timer Countdown ==

loop Every Frame (120 frames)
    Player -> BomberQuest: Timer tick
    activate BomberQuest
    
    BomberQuest -> GameManager: update()
    activate GameManager
    
    GameManager -> PlayingState: update(this)
    activate PlayingState
    
    PlayingState -> GameManager: getBombs()
    activate GameManager
    GameManager --> PlayingState: bombList
    deactivate GameManager
    
    loop For each bomb
        PlayingState -> Bomb: update()
        activate Bomb
        
        Bomb -> Bomb: timer--
        
        alt timer <= 0
            Bomb -> Bomb: active = false
        end
        
        Bomb --> PlayingState
        deactivate Bomb
    end
    
    PlayingState --> GameManager
    deactivate PlayingState
    
    GameManager --> BomberQuest
    deactivate GameManager
    deactivate BomberQuest
end

== Explosion Trigger ==

Player -> BomberQuest: Timer tick
activate BomberQuest

BomberQuest -> GameManager: update()
activate GameManager

GameManager -> PlayingState: update(this)
activate PlayingState

PlayingState -> Bomb: isActive()
activate Bomb
Bomb --> PlayingState: false
deactivate Bomb

PlayingState -> PlayingState: triggerExplosion(bx, by, radius)
activate PlayingState

PlayingState -> GameManager: getExplosions()
activate GameManager
GameManager --> PlayingState: explosionList
deactivate GameManager

' Center explosion
PlayingState -> Explosion: new Explosion(bx, by)
activate Explosion
Explosion --> PlayingState
deactivate Explosion

PlayingState -> GameManager: explosions.add(explosion)

' Directional explosions
loop For each direction (up, down, left, right)
    loop For each tile in radius
        PlayingState -> PlayingState: Calculate target (tx, ty)
        
        PlayingState -> PlayingState: Check bounds
        
        alt In bounds
            PlayingState -> GameManager: getWalls()
            activate GameManager
            GameManager --> PlayingState: wallList
            deactivate GameManager
            
            loop For each wall
                alt Wall at (tx, ty)
                    PlayingState -> Wall: isDestructible()
                    activate Wall
                    Wall --> PlayingState: true/false
                    deactivate Wall
                    
                    alt Destructible wall
                        PlayingState -> GameManager: walls.remove(wall)
                        PlayingState -> PlayingState: hitSoft = true
                    else Hard wall
                        PlayingState -> PlayingState: hitHard = true
                    end
                end
            end
            
            alt !hitHard
                PlayingState -> Explosion: new Explosion(tx, ty)
                activate Explosion
                Explosion --> PlayingState
                deactivate Explosion
                
                PlayingState -> GameManager: explosions.add(explosion)
                
                alt hitSoft
                    PlayingState -> PlayingState: break radius loop
                end
            else hitHard
                PlayingState -> PlayingState: break radius loop
            end
        end
    end
end

deactivate PlayingState

PlayingState -> SoundManager: playSFX(SFX_EXPLOSION)
activate SoundManager
SoundManager --> PlayingState
deactivate SoundManager

PlayingState -> GameManager: bombs.remove(bomb)

PlayingState --> GameManager
deactivate PlayingState

GameManager --> BomberQuest
deactivate GameManager

deactivate BomberQuest

== Explosion Damage ==

loop For 15 frames
    Player -> BomberQuest: Timer tick
    activate BomberQuest
    
    BomberQuest -> GameManager: update()
    activate GameManager
    
    GameManager -> PlayingState: update(this)
    activate PlayingState
    
    PlayingState -> GameManager: getExplosions()
    activate GameManager
    GameManager --> PlayingState: explosionList
    deactivate GameManager
    
    loop For each explosion
        PlayingState -> Explosion: update()
        activate Explosion
        Explosion -> Explosion: timer--
        alt timer <= 0
            Explosion -> Explosion: active = false
        end
        Explosion --> PlayingState
        deactivate Explosion
        
        ' Check player collision
        PlayingState -> GameManager: getPlayer()
        activate GameManager
        GameManager --> PlayingState: player
        deactivate GameManager
        
        alt explosion.pos == player.pos
            PlayingState -> Player: damage()
            activate Player
            Player -> Player: hp--
            Player -> Player: invincibleTimer = 120
            Player --> PlayingState: true (damaged)
            deactivate Player
            
            alt player.hp <= 0
                PlayingState -> SoundManager: playSFX(SFX_DEATH)
            else player.hp > 0
                PlayingState -> SoundManager: playSFX(SFX_DAMAGE)
            end
        end
        
        ' Check enemy collision
        PlayingState -> GameManager: getEnemies()
        activate GameManager
        GameManager --> PlayingState: enemyList
        deactivate GameManager
        
        loop For each enemy
            alt explosion.pos == enemy.pos
                PlayingState -> GameManager: enemies.remove(enemy)
            end
        end
        
        alt !explosion.isActive()
            PlayingState -> GameManager: explosions.remove(explosion)
        end
    end
    
    PlayingState --> GameManager
    deactivate PlayingState
    
    GameManager --> BomberQuest
    deactivate GameManager
    
    deactivate BomberQuest
end

@enduml

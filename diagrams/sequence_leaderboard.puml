@startuml Leaderboard_Save_Sequence

actor Player
participant VictoryState
participant LeaderboardManager
participant FileSystem

== Victory Screen ==

Player -> VictoryState: Game won
activate VictoryState

VictoryState -> VictoryState: username = empty
VictoryState -> VictoryState: saved = false

VictoryState --> Player: Show victory screen
deactivate VictoryState

== Username Input ==

loop Until saved
    Player -> VictoryState: Type character
    activate VictoryState
    
    alt Valid character (A-Z, 0-9, Space)
        VictoryState -> VictoryState: username.append(char)
        VictoryState --> Player: Display username + "_"
    else Backspace
        VictoryState -> VictoryState: username.deleteLastChar()
        VictoryState --> Player: Display username + "_"
    end
    
    deactivate VictoryState
end

== Save Score ==

Player -> VictoryState: Press ENTER
activate VictoryState

VictoryState -> VictoryState: Check username length > 0

alt Username valid
    VictoryState -> VictoryState: name = username.trim()
    
    VictoryState -> LeaderboardManager: getInstance()
    activate LeaderboardManager
    LeaderboardManager --> VictoryState: instance
    deactivate LeaderboardManager
    
    VictoryState -> LeaderboardManager: isNameTaken(name)
    activate LeaderboardManager
    
    LeaderboardManager -> LeaderboardManager: scores.containsKey(name)
    
    alt Name already exists
        LeaderboardManager --> VictoryState: true
        deactivate LeaderboardManager
        
        VictoryState -> VictoryState: errorMessage = "Name taken!"
        VictoryState --> Player: Show error
        
    else Name available
        LeaderboardManager --> VictoryState: false
        deactivate LeaderboardManager
        
        VictoryState -> GameManager: getLastGameTime()
        activate GameManager
        GameManager --> VictoryState: time
        deactivate GameManager
        
        VictoryState -> LeaderboardManager: addScore(name, time)
        activate LeaderboardManager
        
        LeaderboardManager -> LeaderboardManager: scores.put(name, time)
        
        note right of LeaderboardManager
            If name exists, only updates
            if new time is better (lower)
        end note
        
        LeaderboardManager -> LeaderboardManager: saveScores()
        activate LeaderboardManager
        
        LeaderboardManager -> FileSystem: Open leaderboard.dat
        activate FileSystem
        FileSystem --> LeaderboardManager: FileWriter
        deactivate FileSystem
        
        loop For each entry in scores
            LeaderboardManager -> FileSystem: write(name:time)
            activate FileSystem
            FileSystem --> LeaderboardManager
            deactivate FileSystem
        end
        
        LeaderboardManager -> FileSystem: close()
        activate FileSystem
        FileSystem --> LeaderboardManager
        deactivate FileSystem
        
        deactivate LeaderboardManager
        
        LeaderboardManager --> VictoryState: Score saved
        deactivate LeaderboardManager
        
        VictoryState -> VictoryState: saved = true
        VictoryState -> VictoryState: errorMessage = ""
        
        VictoryState --> Player: Show "Score Saved!"
    end
end

deactivate VictoryState

== Post-Save Options ==

Player -> VictoryState: Press ENTER (Play Again)
activate VictoryState

VictoryState -> GameManager: setState(DIFFICULTY_SELECTION_STATE)
activate GameManager
GameManager --> VictoryState
deactivate GameManager

VictoryState -> VictoryState: reset()
VictoryState -> VictoryState: username.clear()
VictoryState -> VictoryState: saved = false

VictoryState --> Player
deactivate VictoryState

== Leaderboard Display ==

Player -> MainMenuState: Select Leaderboard
activate MainMenuState

MainMenuState -> GameManager: setState(LEADERBOARD_STATE)
activate GameManager
GameManager --> MainMenuState
deactivate GameManager

deactivate MainMenuState

Player -> LeaderboardState: Display
activate LeaderboardState

LeaderboardState -> LeaderboardManager: getInstance()
activate LeaderboardManager
LeaderboardManager --> LeaderboardState: instance
deactivate LeaderboardManager

LeaderboardState -> LeaderboardManager: getTopScores()
activate LeaderboardManager

LeaderboardManager -> LeaderboardManager: Load scores from map

LeaderboardManager -> LeaderboardManager: Sort by value (ascending)
note right
    Lower time = better score
end note

LeaderboardManager -> LeaderboardManager: Return top 10

LeaderboardManager --> LeaderboardState: List<Entry<String, Integer>>
deactivate LeaderboardManager

loop For each score (max 10)
    LeaderboardState -> LeaderboardState: Format and display
    note right
        Format:
        #1 PLAYER_NAME  02:35
        #2 PLAYER2      03:12
        ...
        
        Special colors:
        #1 = Gold
        #2 = Silver
        #3 = Bronze
    end note
end

LeaderboardState --> Player: Display leaderboard
deactivate LeaderboardState

@enduml
